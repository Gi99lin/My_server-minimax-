# Проверка блокировки пакетов провайдером

## Цель
Определить, блокирует ли провайдер пакеты между сервером и iPhone.

## Тест 1: Двусторонний tcpdump на сервере

### Запуск:
```bash
cd /Users/ivanakimkin/Projects/My_server\(minimax\)
chmod +x scripts/debug/trace_bidirectional.exp
./scripts/debug/trace_bidirectional.exp 37.60.251.4 Tanquzsacjev5hywvo
```

### Что делать:
1. Скрипт запустит tcpdump на 30 секунд
2. **Держите VPN подключенным**
3. **Откройте на iPhone:** http://neverssl.com (простой HTTP-сайт)
4. Смотрите результаты

### Интерпретация:

**Сценарий A: Видны пакеты в ОБЕ стороны**
```
eth0 Out IP 37.60.251.4 > 128.0.130.144  (сервер → iPhone)
eth0 In  IP 128.0.130.144 > 37.60.251.4  (iPhone → сервер)
```
→ **Сеть работает!** Проблема в конфигурации VPN или DNS.

**Сценарий B: Видны ТОЛЬКО исходящие (Out)**
```
eth0 Out IP 37.60.251.4 > 128.0.130.144  (сервер → iPhone)
(нет входящих пакетов)
```
→ **Провайдер блокирует** ответы от сервера к iPhone.

**Сценарий C: Ничего не видно**
```
(пустой вывод)
```
→ VPN не передаёт трафик вообще.

---

## Тест 2: tcpdump на Mac (если iPhone в той же сети)

Если iPhone подключен к той же Wi-Fi сети, что и Mac:

### На Mac:
```bash
# Узнайте интерфейс Wi-Fi
ifconfig | grep -A 5 "en0"

# Запустите tcpdump
sudo tcpdump -i en0 -nn 'host 37.60.251.4' -v
```

### Что делать:
1. Запустите tcpdump на Mac
2. На iPhone откройте http://neverssl.com через VPN
3. Смотрите, видит ли Mac пакеты от/к серверу

### Интерпретация:

**Если Mac видит пакеты:**
```
IP 192.168.X.X > 37.60.251.4  (iPhone → сервер)
IP 37.60.251.4 > 192.168.X.X  (сервер → iPhone)
```
→ Пакеты доходят до локальной сети, проблема в iPhone или VPN-клиенте.

**Если Mac НЕ видит пакеты от сервера:**
```
IP 192.168.X.X > 37.60.251.4  (только исходящие)
```
→ Провайдер блокирует ответы от сервера.

---

## Тест 3: MTR (My Traceroute) - путь пакетов

Показывает весь маршрут пакетов и где они теряются:

### На сервере:
```bash
ssh root@37.60.251.4
apt-get install -y mtr
mtr -r -c 10 128.0.130.144
```

### Интерпретация:
```
HOST: vmi3007435               Loss%   Snt   Last   Avg
1. 37.60.251.1                  0.0%    10    0.5   0.5
2. 10.0.0.1                     0.0%    10    1.2   1.1
3. ???                        100.0%    10    0.0   0.0  <- Здесь блокировка
```

Если видите 100% Loss на каком-то хопе → там блокировка.

---

## Тест 4: Проверка через VPN-туннель

Самый точный тест - смотрим трафик ВНУТРИ VPN-туннеля:

### На сервере:
```bash
ssh root@37.60.251.4

# Смотрим трафик на VPN-порту 54321
tcpdump -i any -nn 'port 54321' -X -v

# В другом окне смотрим трафик от VPN-клиента
tcpdump -i br-c75c3187e51c -nn 'host 172.20.0.3' -v
```

### На iPhone:
Откройте http://neverssl.com

### Что искать:

**Успешный сценарий:**
```
# Порт 54321 - зашифрованный VPN-трафик
IP 128.0.130.144.XXXXX > 37.60.251.4.54321: [encrypted data]
IP 37.60.251.4.54321 > 128.0.130.144.XXXXX: [encrypted data]

# Внутри VPN - расшифрованный HTTP
IP 172.20.0.3.XXXXX > 93.184.216.34.80: GET / HTTP/1.1
IP 93.184.216.34.80 > 172.20.0.3.XXXXX: HTTP/1.1 200 OK
```

**Проблемный сценарий:**
```
# VPN-туннель работает
IP 128.0.130.144 > 37.60.251.4.54321: OK
IP 37.60.251.4.54321 > 128.0.130.144: OK

# Но HTTP-запросы не проходят
IP 172.20.0.3 > 93.184.216.34.80: GET /
(нет ответа)
```
→ Проблема в роутинге или firewall на сервере.

---

## Тест 5: Сравнение с рабочим VPN

Если у вас есть доступ к другому VPN (который работает):

1. Подключитесь к рабочему VPN
2. Запустите tcpdump на Mac: `sudo tcpdump -i en0 -nn -v`
3. Откройте сайт
4. Сохраните вывод

5. Подключитесь к вашему VPN
6. Запустите тот же tcpdump
7. Откройте тот же сайт
8. Сравните выводы

**Разница покажет, что именно не работает.**

---

## Автоматический тест

Запустите скрипт, который сделает всё автоматически:

```bash
./scripts/debug/trace_bidirectional.exp 37.60.251.4 Tanquzsacjev5hywvo
```

Держите VPN подключенным и попробуйте открыть сайт во время захвата.

---

## Что делать с результатами

После тестов у вас будет чёткое понимание:

1. **Доходят ли пакеты от сервера до iPhone?**
   - Да → проблема в VPN-конфигурации
   - Нет → провайдер блокирует

2. **На каком этапе теряются пакеты?**
   - В VPN-туннеле → проблема в Xray
   - После туннеля → проблема в роутинге
   - До iPhone → провайдер блокирует

3. **Работает ли обратный путь?**
   - Да → проблема односторонняя
   - Нет → полная блокировка
